name: CI

on:
  push:
    branches: [main, bot/integration]
  pull_request:
    branches: [main, bot/integration]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs_relevance:
    name: Docs Relevance
    runs-on: ubuntu-latest
    outputs:
      docs_relevant: ${{ steps.output.outputs.docs_relevant }}
    steps:
      - name: Detect docs-site related changes
        id: filter
        if: github.event_name == 'pull_request'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs_site:
              - 'docs-site/**'
              - '.github/workflows/ci.yml'
              - 'package.json'
              - 'pnpm-lock.yaml'

      - name: Set docs relevance output
        id: output
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ steps.filter.outputs.docs_site }}" = "true" ]; then
            echo "docs_relevant=true" >> "$GITHUB_OUTPUT"
          else
            echo "docs_relevant=false" >> "$GITHUB_OUTPUT"
          fi

  docs_site_ci:
    name: Docs Site CI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [docs_relevance]
    steps:
      - name: Decide whether to run docs build
        id: decision
        run: |
          RUN_DOCS_BUILD=false
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            RUN_DOCS_BUILD=true
          elif [ "${{ needs.docs_relevance.outputs.docs_relevant }}" = "true" ]; then
            RUN_DOCS_BUILD=true
          fi

          echo "event_name=${{ github.event_name }}"
          echo "docs_relevant=${{ needs.docs_relevance.outputs.docs_relevant }}"
          echo "run_docs_build=$RUN_DOCS_BUILD"
          echo "run_docs_build=$RUN_DOCS_BUILD" >> "$GITHUB_OUTPUT"

      - name: Skip docs-site build (not relevant)
        if: steps.decision.outputs.run_docs_build != 'true'
        run: echo "Skipping docs-site build for this pull request (no relevant file changes)."

      - name: Checkout
        if: steps.decision.outputs.run_docs_build == 'true'
        uses: actions/checkout@v4

      - name: Install pnpm
        if: steps.decision.outputs.run_docs_build == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: Setup Node.js
        if: steps.decision.outputs.run_docs_build == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: docs-site/pnpm-lock.yaml

      - name: Install docs-site dependencies
        if: steps.decision.outputs.run_docs_build == 'true'
        run: pnpm -C docs-site install --frozen-lockfile

      - name: Run docs doctor
        if: steps.decision.outputs.run_docs_build == 'true'
        run: pnpm docs:doctor

      - name: Build docs-site
        if: steps.decision.outputs.run_docs_build == 'true'
        run: pnpm -C docs-site build

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Cache ripgrep
        id: cache-ripgrep
        uses: actions/cache@v4
        with:
          path: /usr/bin/rg
          key: ripgrep-${{ runner.os }}-14.1

      - name: Install ripgrep
        if: steps.cache-ripgrep.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.1/ripgrep_14.1.1-1_amd64.deb
          sudo dpkg -i ripgrep_14.1.1-1_amd64.deb

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Verify npm pack artifact
        run: pnpm verify:pack

      - name: Typecheck
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: Check for dead code (Knip)
        run: pnpm knip

      - name: Run tests (excluding PTY)
        run: pnpm test -- --exclude='**/*.pty.test.ts'

      - name: Run tests (excluding PTY) with dist
        run: pnpm test -- --exclude='**/*.pty.test.ts'
        env:
          BWRB_TEST_DIST: 1

  test-pty:
    name: PTY Tests
    runs-on: ubuntu-latest
    # PTY tests may fail in CI due to terminal emulation issues
    # We track these separately and allow failures while debugging
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Cache ripgrep
        id: cache-ripgrep
        uses: actions/cache@v4
        with:
          path: /usr/bin/rg
          key: ripgrep-${{ runner.os }}-14.1

      - name: Install ripgrep
        if: steps.cache-ripgrep.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.1/ripgrep_14.1.1-1_amd64.deb
          sudo dpkg -i ripgrep_14.1.1-1_amd64.deb

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Verify PTY filter
        # Sanity check: ensure filter matches PTY tests
        # Note: If node-pty fails to load, vitest may report no tests
        run: |
          # Count PTY test files directly from filesystem
          PTY_FILES=$(find tests -name "*.pty.test.ts" | wc -l | tr -d ' ')
          echo "Found $PTY_FILES PTY test files in repository"
          if [ "$PTY_FILES" -eq 0 ]; then
            echo "ERROR: No PTY test files found"
            exit 1
          fi
          echo "PTY test files:"
          find tests -name "*.pty.test.ts"

      - name: Prepare PTY artifacts directory
        run: mkdir -p artifacts

      - name: Run PTY tests
        run: |
          set -o pipefail
          pnpm test:pty:ci 2>&1 | tee artifacts/pty.log
        env:
          # Force color output for better debugging
          FORCE_COLOR: 1

      - name: Summarize PTY failures
        if: always()
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = 'artifacts/pty-results.json';
          if (!fs.existsSync(path)) {
            console.log('PTY summary: results file not found.');
            process.exit(0);
          }
          const data = JSON.parse(fs.readFileSync(path, 'utf8'));
          const failed = [];
          (data.testResults || []).forEach((suite) => {
            (suite.assertionResults || []).forEach((test) => {
              if (test.status === 'failed') {
                failed.push({
                  name: test.fullName || test.title || suite.name || 'unknown',
                  messages: test.failureMessages || [],
                });
              }
            });
          });
          if (!failed.length) {
            console.log('PTY summary: no failed tests.');
            process.exit(0);
          }
          console.log('PTY summary: failed tests');
          failed.forEach((test) => {
            console.log(`- ${test.name}`);
            test.messages.slice(0, 2).forEach((msg) => {
              const line = String(msg).split('\n')[0];
              if (line) {
                console.log(`  ${line}`);
              }
            });
          });
          NODE

      - name: Upload PTY artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pty-test-artifacts
          path: |
            artifacts/pty.log
            artifacts/pty-results.json
          if-no-files-found: warn
